<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sand.js Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }
    body { margin: 0; padding: 2rem; display: flex; flex-direction: column; gap: 2rem; align-items: center; }
    header { text-align: center; }
    svg { max-width: min(480px, 90vw); max-height: min(480px, 90vw); width: 100%; height: auto; display: block; }
    figcaption { margin-top: 1rem; font-size: 0.9rem; color: #cbd5f5; }
    .sand-arc {
      stroke: #0f172a;
      stroke-width: 1;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: opacity 120ms ease-in-out, stroke-width 120ms ease-in-out, stroke 120ms ease-in-out;
      cursor: pointer;
    }
    .sand-arc.is-hover { opacity: 0.7; stroke-width: 1.5; stroke: #e2e8f0; }
    .sand-arc.is-pinned { opacity: 0.95; stroke-width: 2.5; stroke: #f1f5f9; }
    .selection { font-size: 0.95rem; color: #e0f2fe; text-align: center; min-height: 1.4rem; }
    .breadcrumbs { font-size: 0.85rem; color: #cbd5f5; text-align: center; min-height: 1.2rem; letter-spacing: 0.01em; }
    .error { color:#fecaca }
  </style>
</head>
<body>
<header>
  <h1>Sand.js Sunburst Demo</h1>
  <p>Run <code>npm run build</code>, then serve <code>demo/</code> with a static server (e.g. <code>npx http-server demo</code>).</p>
</header>

<figure>
  <svg id="sunburst" role="img" aria-label="Sand.js demo sunburst"></svg>
  <figcaption>Data-driven layout via <code>demo/data.json</code>.</figcaption>
</figure>

<p id="selection" class="selection">Loading data…</p>
<p id="breadcrumbs" class="breadcrumbs">Path: —</p>

<script type="module">
  import { renderSVG } from '../dist/sandjs.mjs';

  const selectionEl = document.getElementById('selection');
  const breadcrumbsEl = document.getElementById('breadcrumbs');
  const defaultMessage = 'Hover an arc to preview details, click to pin.';
  const defaultBreadcrumbs = 'Path: —';
  const formatValue = (value) => (Number.isFinite(value) ? value.toLocaleString() : '—');
  const formatBreadcrumb = (arc) => arc.path.map((node) => node.name).join(' › ');

  const setSelection = (msg, cls='') => {
    selectionEl.className = `selection ${cls}`.trim();
    selectionEl.textContent = msg;
  };

  const setBreadcrumbs = (msg) => {
    breadcrumbsEl.textContent = msg;
  };

  // simple categorical palette (fallback if node.color not provided)
  const palette = ['#f97316','#facc15','#22d3ee','#a855f7','#4ade80','#fb7185'];
  const colorByKey = new Map();
  let idx = 0;
  const assignColor = (k) => {
    if (!colorByKey.has(k)) colorByKey.set(k, palette[idx++ % palette.length]);
    return colorByKey.get(k);
  };

  const state = {
    pinned: null,
  };

  const clearHovers = () => {
    document.querySelectorAll('.sand-arc.is-hover').forEach((el) => el.classList.remove('is-hover'));
  };

  const applyHover = (path) => {
    if (state.pinned?.path === path) {
      return;
    }
    path.classList.add('is-hover');
  };

  const showPinnedInfo = () => {
    if (!state.pinned) {
      setSelection(defaultMessage);
      setBreadcrumbs(defaultBreadcrumbs);
      return;
    }
    const { arc } = state.pinned;
    setSelection(
      `Pinned: ${arc.data.name} · ${formatValue(arc.value)} · ${(arc.percentage * 100).toFixed(1)}%`,
    );
    setBreadcrumbs(`Path: ${formatBreadcrumb(arc)}`);
  };

  const togglePinned = (path, arc) => {
    if (state.pinned?.path === path) {
      state.pinned.path.classList.remove('is-pinned');
      state.pinned = null;
      clearHovers();
      setSelection(defaultMessage);
      setBreadcrumbs(defaultBreadcrumbs);
      return;
    }

    if (state.pinned) {
      state.pinned.path.classList.remove('is-pinned');
    }

    clearHovers();
    path.classList.remove('is-hover');
    // Move the pinned arc to the end of the SVG so the white stroke sits above neighbors.
    if (path.parentNode) {
      path.parentNode.appendChild(path);
    }
    path.classList.add('is-pinned');
    state.pinned = { path, arc };
    showPinnedInfo();
  };

  // load and render
  try {
    // IMPORTANT: this path is relative to demo/index.html
    const config = await fetch('./demo/data.json').then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    });

    // If your data doesn’t embed colors, this decorator gives stable colors per key
    const chart = renderSVG({
      el: '#sunburst',
      config,
      classForArc: (arc) => (arc.depth === 0 ? 'sand-arc is-root' : 'sand-arc'),
      decoratePath(path, arc) {
        const labelValue = formatValue(arc.value);
        path.setAttribute(
          'aria-label',
          `${formatBreadcrumb(arc)}: ${labelValue} (${(arc.percentage * 100).toFixed(1)}%)`,
        );
        // prefer explicit node color; otherwise color by key/name
        const explicit = arc.data.color;
        const k = arc.key || arc.data.key || arc.data.name;
        const fill = explicit || assignColor(k);
        path.setAttribute('fill', fill);
      },
      tooltip: true,
      onArcEnter: ({ arc, path }) => {
        applyHover(path);
        setSelection(
          `Preview: ${arc.data.name} · ${formatValue(arc.value)} · ${(arc.percentage * 100).toFixed(1)}%`,
        );
        setBreadcrumbs(`Path: ${formatBreadcrumb(arc)}`);
      },
      onArcMove: ({ arc, path }) => {
        applyHover(path);
        setSelection(
          `Preview: ${arc.data.name} · ${formatValue(arc.value)} · ${(arc.percentage * 100).toFixed(1)}%`,
        );
        setBreadcrumbs(`Path: ${formatBreadcrumb(arc)}`);
      },
      onArcLeave: ({ path }) => {
        if (!state.pinned || state.pinned.path !== path) {
          path.classList.remove('is-hover');
        }
        if (state.pinned) {
          showPinnedInfo();
        } else {
          setSelection(defaultMessage);
          setBreadcrumbs(defaultBreadcrumbs);
        }
      },
      onArcClick: ({ arc, path, event }) => {
        event.preventDefault();
        togglePinned(path, arc);
      }
    });

    // optional: expose for debugging in console
    window.chart = chart;
    setSelection(defaultMessage);
    setBreadcrumbs(defaultBreadcrumbs);
  } catch (err) {
    console.error(err);
    setSelection(`Failed to load demo/data.json: ${err.message}`, 'error');
    setBreadcrumbs(defaultBreadcrumbs);
  }
</script>
</body>
</html>
