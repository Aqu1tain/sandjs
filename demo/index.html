<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sand.js Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: clamp(1.5rem, 4vw, 3rem);
    }

    .app {
      width: min(1080px, 100%);
      display: flex;
      flex-direction: column;
      gap: clamp(1.25rem, 2vw, 2rem);
      background: #111c2f;
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 1.25rem;
      padding: clamp(1.5rem, 3vw, 2.5rem);
    }

    .app__header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .app__title {
      margin: 0;
      font-size: clamp(1.8rem, 3.4vw, 2.6rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      color: #f8fafc;
    }

    .app__tagline {
      margin: 0;
      font-size: clamp(0.95rem, 1.6vw, 1.05rem);
      color: rgba(226, 232, 240, 0.85);
    }

    .app__meta {
      margin: 0;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: rgba(148, 163, 184, 0.8);
    }

    .app__layout {
      display: grid;
      gap: clamp(1.25rem, 2vw, 2rem);
      grid-template-columns: minmax(0, 1fr);
    }

    @media (min-width: 960px) {
      .app__layout {
        grid-template-columns: minmax(0, 3fr) minmax(320px, 2fr);
      }
    }

    .panel {
      background: #0f172a;
      border: 1px solid rgba(51, 65, 85, 0.45);
      border-radius: 1rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel__header {
      padding: 1.2rem 1.4rem 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .panel__header h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #cbd5f5;
    }

    .panel__subtitle {
      font-size: 0.78rem;
      color: rgba(148, 163, 184, 0.8);
    }

    .panel__body {
      padding: 0 1.4rem 1.4rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .panel__body--stacked {
      gap: 1rem;
    }

    .canvas {
      margin: 0;
      background: #0b1324;
      border-radius: 0.9rem;
      padding: clamp(1rem, 2vw, 1.4rem);
      border: 1px solid rgba(59, 130, 246, 0.18);
    }

    svg {
      width: 100%;
      max-width: min(440px, 100%);
      aspect-ratio: 1 / 1;
      display: block;
      margin: 0 auto;
    }

    figcaption {
      margin-top: 1rem;
      font-size: 0.78rem;
      text-align: center;
      color: rgba(148, 163, 184, 0.85);
    }

    .insights {
      display: grid;
      gap: 0.6rem;
    }

    .selection {
      font-size: 0.95rem;
      color: #e0f2fe;
      min-height: 1.4rem;
      margin: 0;
    }

    .breadcrumbs {
      font-size: 0.82rem;
      color: rgba(203, 213, 225, 0.9);
      min-height: 1.2rem;
      margin: 0;
      letter-spacing: 0.01em;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      padding: 0.9rem 1rem;
      border-radius: 0.85rem;
      background: #0b1324;
      border: 1px solid rgba(71, 85, 105, 0.4);
      font-size: 0.78rem;
    }

    .controls strong {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(226, 232, 240, 0.85);
    }

    .controls__label {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      padding: 0.5rem 0.6rem;
      border-radius: 0.65rem;
      background: transparent;
      border: 1px solid rgba(51, 65, 85, 0.35);
      transition: background 120ms ease, border-color 120ms ease;
      cursor: pointer;
    }

    .controls__label:hover {
      background: rgba(30, 41, 59, 0.6);
      border-color: rgba(148, 163, 184, 0.4);
    }

    .controls__toggle {
      accent-color: #38bdf8;
    }

    .editor {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .editor__heading {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .editor__heading strong {
      font-size: 0.88rem;
      color: rgba(248, 250, 252, 0.9);
    }

    .editor__badge {
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(34, 211, 238, 0.12);
      color: #22d3ee;
      border: 1px solid rgba(34, 211, 238, 0.3);
    }

    .editor__hint {
      font-size: 0.75rem;
      color: rgba(148, 163, 184, 0.85);
      margin: 0;
    }

    .editor__textarea {
      width: 100%;
      min-height: clamp(200px, 35vh, 260px);
      background: #0b1324;
      border: 1px solid rgba(71, 85, 105, 0.55);
      border-radius: 0.75rem;
      padding: 0.9rem;
      color: inherit;
      font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.78rem;
      line-height: 1.45;
      resize: vertical;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    .editor__textarea:focus {
      outline: none;
      border-color: rgba(51, 153, 255, 0.7);
      box-shadow: 0 0 0 1px rgba(51, 153, 255, 0.35);
    }

    .editor__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .editor__button {
      background: #38bdf8;
      color: #0f172a;
      border: none;
      border-radius: 0.65rem;
      padding: 0.5rem 1.2rem;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 120ms ease, transform 120ms ease;
    }

    .editor__button:hover {
      background: #22d3ee;
      transform: translateY(-1px);
    }

    .editor__button:active {
      transform: none;
    }

    .editor__button--ghost {
      background: transparent;
      color: #38bdf8;
      border: 1px solid rgba(56, 189, 248, 0.45);
    }

    .editor__status {
      min-height: 1.2rem;
      font-size: 0.75rem;
      letter-spacing: 0.01em;
    }

    .editor__status--muted {
      color: rgba(148, 163, 184, 0.85);
    }

    .editor__status--success {
      color: #bef264;
    }

    .editor__status--error {
      color: #fecaca;
    }

    .sand-arc {
      stroke: rgba(15, 23, 42, 0.85);
      stroke-width: 1;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: opacity 130ms ease-in-out, stroke-width 130ms ease-in-out, stroke 130ms ease-in-out;
      cursor: pointer;
    }

    .sand-arc.is-hover {
      opacity: 0.78;
      stroke-width: 1.5;
      stroke: #f8fafc;
    }

    .sand-arc.is-related {
      opacity: 0.62;
      stroke-width: 1.4;
      stroke: rgba(148, 163, 184, 0.55);
    }

    .sand-arc.is-pinned {
      opacity: 1;
      stroke-width: 2.4;
      stroke: #f1f5f9;
    }

    .sand-arc.is-collapsed {
      stroke-dasharray: 4 2;
      opacity: 0.85;
    }

    .error {
      color: #fecaca;
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="app__header">
      <h1 class="app__title">Sand.js Studio</h1>
      <p class="app__tagline">Tinker with sunburst anatomy, inspect arcs, and iterate on layouts in real time.</p>
      <p class="app__meta">Tip : `npm run build` then serve <code>./</code> (ex. <code>npx http-server .</code>).</p>
    </header>

    <section class="app__layout">
      <section class="panel panel--visual" aria-labelledby="panel-visual-title">
        <div class="panel__header">
          <h2 id="panel-visual-title">Visualisation</h2>
          <span class="panel__subtitle">Arc metadata, tooltips & interactions</span>
        </div>
        <div class="panel__body">
          <figure class="canvas">
            <svg id="sunburst" role="img" aria-label="Sand.js demo sunburst"></svg>
            <figcaption>Les arcs utilisent les attributs `data-depth` et `data-collapsed` générés par Sand.js.</figcaption>
          </figure>
          <div class="insights">
            <p id="selection" class="selection">Loading data…</p>
            <p id="breadcrumbs" class="breadcrumbs">Path: —</p>
          </div>
        </div>
      </section>

      <aside class="panel panel--sidebar" aria-labelledby="panel-config-title">
        <div class="panel__header">
          <h2 id="panel-config-title">Configuration</h2>
          <span class="panel__subtitle">Collapse toggles & JSON editor</span>
        </div>
        <div class="panel__body panel__body--stacked">
          <div id="controls" class="controls" aria-live="polite"></div>
          <section class="editor" aria-labelledby="config-editor-title">
            <div class="editor__heading">
              <strong id="config-editor-title">Configuration JSON</strong>
              <span class="editor__badge">Live</span>
            </div>
            <p class="editor__hint">Modifiez <code>demo/data.json</code> directement, appliquez ou réinitialisez les changements à la volée.</p>
            <textarea id="config-editor" class="editor__textarea" spellcheck="false" aria-describedby="config-editor-title"></textarea>
            <div class="editor__actions">
              <button type="button" id="apply-config" class="editor__button">Apply changes</button>
              <button type="button" id="reset-config" class="editor__button editor__button--ghost">Reset to data.json</button>
              <span id="editor-status" class="editor__status editor__status--muted" aria-live="polite"></span>
            </div>
          </section>
        </div>
      </aside>
    </section>
  </main>

<script type="module">
  import { renderSVG, formatArcBreadcrumb } from '../dist/sandjs.mjs';

  const selectionEl = document.getElementById('selection');
  const breadcrumbsEl = document.getElementById('breadcrumbs');
  const defaultMessage = 'Hover an arc to preview details, click to pin. Dashed arcs are collapsed branches.';
  const defaultBreadcrumbs = 'Path: —';
  const formatValue = (value) => (Number.isFinite(value) ? value.toLocaleString() : '—');
  const breadcrumbPath = (arc) => formatArcBreadcrumb(arc);
  const breadcrumbLabel = (arc) => `Path: ${breadcrumbPath(arc)}`;

  const setSelection = (msg, cls='') => {
    selectionEl.className = `selection ${cls}`.trim();
    selectionEl.textContent = msg;
  };

  const setBreadcrumbs = (msg) => {
    breadcrumbsEl.textContent = msg;
  };

  // simple categorical palette (fallback if node.color not provided)
  const palette = ['#f97316','#facc15','#22d3ee','#a855f7','#4ade80','#fb7185'];
  const colorsById = new Map();
  let idx = 0;
  const assignColor = (id) => {
    if (!colorsById.has(id)) colorsById.set(id, palette[idx++ % palette.length]);
    return colorsById.get(id);
  };
  const colorIdForArc = (arc) => arc.path.map((node) => node.name).join(' › ');

  const state = {
    pinned: null,
    collapsedKeys: new Set(),
  };
  let hoverPath = null;

  const clearHover = (path) => {
    if (hoverPath && (!path || hoverPath === path)) {
      hoverPath.classList.remove('is-hover');
      hoverPath = null;
    }
  };

  const applyHover = (path) => {
    if (state.pinned?.path === path) {
      clearHover(path);
      return;
    }
    if (hoverPath && hoverPath !== path) {
      hoverPath.classList.remove('is-hover');
    }
    path.classList.add('is-hover');
    hoverPath = path;
  };

  const showPinnedInfo = () => {
    if (!state.pinned) {
      setSelection(defaultMessage);
      setBreadcrumbs(defaultBreadcrumbs);
      return;
    }
    const { arc } = state.pinned;
    setSelection(
      `Pinned: ${arc.data.name} · ${formatValue(arc.value)} · ${(arc.percentage * 100).toFixed(1)}%`,
    );
    setBreadcrumbs(breadcrumbLabel(arc));
  };

  const handlePinChange = ({ arc, path, pinned }) => {
    clearHover();
    if (pinned) {
      if (path.parentNode) {
        path.parentNode.appendChild(path);
      }
      state.pinned = { arc, path };
      showPinnedInfo();
      return;
    }
    if (state.pinned?.path === path) {
      state.pinned = null;
    }
    showPinnedInfo();
  };

  // load and render
  try {
    // IMPORTANT: this path is relative to demo/index.html
    const config = await fetch('./data.json').then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    });

    const controlsEl = document.getElementById('controls');
    const editorEl = document.getElementById('config-editor');
    const applyConfigButton = document.getElementById('apply-config');
    const resetConfigButton = document.getElementById('reset-config');
    const editorStatus = document.getElementById('editor-status');

    const KEY_SEPARATOR = '\u241F';
    const encodePath = (parts) => parts.join(KEY_SEPARATOR);

    const cloneConfig = (input) =>
      (typeof structuredClone === 'function' ? structuredClone(input) : JSON.parse(JSON.stringify(input)));

    const setEditorStatus = (message, tone = 'muted') => {
      editorStatus.textContent = message;
      editorStatus.className = `editor__status editor__status--${tone}`;
    };

    const collectCollapsedNodes = (sunburstConfig) => {
      const entries = [];
      for (const layer of sunburstConfig.layers) {
        const roots = Array.isArray(layer.tree) ? layer.tree : [layer.tree];
        for (const root of roots) {
          walkNode(root, []);
        }
      }

      function walkNode(node, ancestry) {
        if (!node) return;
        const nextPath = ancestry.concat(node.name ?? '');
        if (node.collapsed) {
          entries.push({
            key: encodePath(nextPath),
            label: node.name ?? 'Unnamed node',
            breadcrumb: nextPath.join(' › '),
          });
        }
        if (Array.isArray(node.children)) {
          node.children.forEach((child) => walkNode(child, nextPath));
        }
      }

      return entries;
    };

    const applyCollapsedState = (sunburstConfig, collapsedSet) => {
      for (const layer of sunburstConfig.layers) {
        const roots = Array.isArray(layer.tree) ? layer.tree : [layer.tree];
        const updated = roots.map((root) => updateNode(root, []));
        layer.tree = Array.isArray(layer.tree) ? updated : updated[0];
      }

      function updateNode(node, ancestry) {
        if (!node) {
          return node;
        }
        const clone = { ...node };
        const nextPath = ancestry.concat(clone.name ?? '');
        const pathKey = encodePath(nextPath);
        if (collapsedSet.has(pathKey)) {
          clone.collapsed = true;
        } else if (clone.collapsed) {
          delete clone.collapsed;
        }
        if (Array.isArray(clone.children)) {
          clone.children = clone.children.map((child) => updateNode(child, nextPath));
        }
        return clone;
      }
    };

    let userConfig = cloneConfig(config);

    const seedCollapsedKeys = () => {
      const entries = collectCollapsedNodes(userConfig);
      state.collapsedKeys = new Set(entries.map((entry) => entry.key));
    };

    const syncEditor = () => {
      editorEl.value = JSON.stringify(userConfig, null, 2);
    };

    seedCollapsedKeys();
    syncEditor();

    const renderControls = () => {
      const collapsedEntries = collectCollapsedNodes(userConfig);
      controlsEl.innerHTML = '';
      if (collapsedEntries.length === 0) {
        controlsEl.textContent = 'No collapsible branches in this dataset.';
        return;
      }

      const heading = document.createElement('strong');
      heading.textContent = 'Collapsed branches';
      controlsEl.appendChild(heading);

      collapsedEntries.forEach((entry) => {
        const wrapper = document.createElement('label');
        wrapper.className = 'controls__label';

        const toggle = document.createElement('input');
        toggle.type = 'checkbox';
        toggle.className = 'controls__toggle';
        toggle.setAttribute('aria-label', `Toggle children for ${entry.breadcrumb}`);

        const text = document.createElement('span');

        const syncToggleUi = () => {
          const isCollapsed = state.collapsedKeys.has(entry.key);
          toggle.checked = !isCollapsed;
          text.textContent = isCollapsed ? `Collapsed: ${entry.label}` : `Expanded: ${entry.label}`;
        };

        toggle.addEventListener('change', () => {
          if (toggle.checked) {
            state.collapsedKeys.delete(entry.key);
          } else {
            state.collapsedKeys.add(entry.key);
          }
          syncToggleUi();
          renderChart();
        });

        syncToggleUi();
        wrapper.appendChild(toggle);
        wrapper.appendChild(text);
        controlsEl.appendChild(wrapper);
      });
    };

    let chart = null;

    const renderChart = () => {
      const nextConfig = cloneConfig(userConfig);
      applyCollapsedState(nextConfig, state.collapsedKeys);
      state.pinned = null;
      clearHover();
      setSelection(defaultMessage);
      setBreadcrumbs(defaultBreadcrumbs);

      if (!chart) {
        chart = renderSVG({
          el: '#sunburst',
          config: nextConfig,
          classForArc: (arc) => (arc.depth === 0 ? 'is-root' : undefined),
          decoratePath(path, arc) {
            const labelValue = formatValue(arc.value);
            path.setAttribute(
              'aria-label',
              `${breadcrumbPath(arc)}: ${labelValue} (${(arc.percentage * 100).toFixed(1)}%)`,
            );
            const explicit = arc.data.color;
            const fill = explicit || assignColor(colorIdForArc(arc));
            path.setAttribute('fill', fill);
          },
          tooltip: true,
          highlightByKey: {
            className: 'is-related',
            pinOnClick: true,
            pinClassName: 'is-pinned',
            onPinChange: handlePinChange,
          },
          breadcrumbs: {
            container: breadcrumbsEl,
            formatter: breadcrumbLabel,
            emptyLabel: defaultBreadcrumbs,
          },
          onArcEnter: ({ arc, path }) => {
            applyHover(path);
            setSelection(
              `Preview: ${arc.data.name} · ${formatValue(arc.value)} · ${(arc.percentage * 100).toFixed(1)}%`,
            );
          },
          onArcMove: ({ arc, path }) => {
            applyHover(path);
            setSelection(
              `Preview: ${arc.data.name} · ${formatValue(arc.value)} · ${(arc.percentage * 100).toFixed(1)}%`,
            );
          },
          onArcLeave: ({ path }) => {
            clearHover(path);
            if (state.pinned) {
              showPinnedInfo();
            } else {
              setSelection(defaultMessage);
              setBreadcrumbs(defaultBreadcrumbs);
            }
          },
          onArcClick: ({ event }) => {
            event.preventDefault();
          }
        });
      } else {
        chart.update({ config: nextConfig });
      }

      window.chart = chart;
    };

    renderControls();
    renderChart();

    setSelection(defaultMessage);
    setBreadcrumbs(defaultBreadcrumbs);
    setEditorStatus('Loaded data.json', 'muted');

    applyConfigButton.addEventListener('click', () => {
      try {
        const parsed = JSON.parse(editorEl.value);
        if (!parsed || typeof parsed !== 'object') {
          throw new Error('Expected a JSON object.');
        }
        if (!parsed.size || typeof parsed.size !== 'object') {
          throw new Error('Missing "size" definition.');
        }
        if (!Array.isArray(parsed.layers)) {
          throw new Error('"layers" must be an array.');
        }

        userConfig = parsed;
        seedCollapsedKeys();
        syncEditor();
        renderControls();
        renderChart();
        setEditorStatus('Configuration applied', 'success');
      } catch (err) {
        console.error(err);
        setEditorStatus(`Invalid configuration: ${err.message}`, 'error');
      }
    });

    resetConfigButton.addEventListener('click', () => {
      userConfig = cloneConfig(config);
      seedCollapsedKeys();
      syncEditor();
      renderControls();
      renderChart();
      setEditorStatus('Reset to data.json', 'muted');
    });
  } catch (err) {
    console.error(err);
    setSelection(`Failed to load demo/data.json: ${err.message}`, 'error');
    setBreadcrumbs(defaultBreadcrumbs);
  }
</script>
</body>
</html>
